<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Soporte PLAi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root { --plai-blue: #003366; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: var(--plai-blue) !important; color: white; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 12px; }
        .table-container { background: white; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .badge-prioridad-alta { background-color: #ff4d4d; color: white; }
        .badge-prioridad-media { background-color: #ffcc00; color: black; }
        .badge-prioridad-baja { background-color: #28a745; color: white; }
        .img-adjunto { 
            width: 40px; 
            height: 40px; 
            object-fit: cover; 
            border-radius: 6px; 
            cursor: pointer;
            border: 1px solid #ddd;
            transition: transform 0.2s;
        }
        .img-adjunto:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Soporte Inteligente PLAi</span>
    </div>
</nav>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-10">
            <input type="text" id="searchInput" class="form-control" placeholder="Buscar por ID, nombre, email o mensaje...">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="fetchTickets()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
        </div>
    </div>

    <div class="table-container shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th>Área</th>
                        <th>Categoría</th>
                        <th>Prioridad</th>
                        <th>Estatus</th>
                        <th>Adjunto</th>
                    </tr>
                </thead>
                <tbody id="ticketsTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // URL de tu Webhook de n8n (Dashboard API - Tickets GET)
    const API_URL = 'https://tu-instancia.n8n.cloud/webhook/dashboard/tickets';

    async function fetchTickets() {
        const tableBody = document.getElementById('ticketsTableBody');
        const search = document.getElementById('searchInput').value;
        
        try {
            const response = await fetch(`${API_URL}?search=${encodeURIComponent(search)}`);
            const data = await response.json();

            if (data.ok && data.tickets) {
                renderTickets(data.tickets);
            }
        } catch (error) {
            console.error('Error al obtener tickets:', error);
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al conectar con la API</td></tr>';
        }
    }

    function renderTickets(tickets) {
        const tableBody = document.getElementById('ticketsTableBody');
        tableBody.innerHTML = '';

        tickets.forEach(ticket => {
            // Lógica para el badge de prioridad
            const prioridadClass = `badge-prioridad-${ticket.prioridad.toLowerCase()}`;
            
            // Lógica corregida para el ADJUNTO
            let adjuntoHtml = '<span class="text-muted">—</span>';
            
            if (ticket.attachments && ticket.attachments.length > 0) {
                const file = ticket.attachments[0]; // Tomamos el primer adjunto
                const isImage = file.mime_type && file.mime_type.includes('image');
                
                if (isImage) {
                    // Renderizamos miniatura si es imagen
                    adjuntoHtml = `
                        <a href="${file.url}" target="_blank" title="Ver imagen completa">
                            <img src="${file.url}" class="img-adjunto" alt="Adjunto">
                        </a>`;
                } else {
                    // Icono de clip si es otro tipo de archivo
                    adjuntoHtml = `
                        <a href="${file.url}" target="_blank" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-paperclip"></i> Ver
                        </a>`;
                }
            }

            const row = `
                <tr>
                    <td><strong>${ticket.ticket_id}</strong></td>
                    <td><small>${new Date(ticket.fecha_creacion).toLocaleString()}</small></td>
                    <td>
                        <div class="fw-bold">${ticket.nombre}</div>
                        <div class="text-muted small">${ticket.email}</div>
                    </td>
                    <td><span class="badge bg-secondary">${ticket.area_soporte}</span></td>
                    <td>${ticket.categoria}</td>
                    <td><span class="badge ${prioridadClass}">${ticket.prioridad.toUpperCase()}</span></td>
                    <td><span class="badge bg-info text-dark">${ticket.estatus}</span></td>
                    <td>${adjuntoHtml}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    // Cargar datos al iniciar y al escribir en el buscador
    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') fetchTickets();
    });

    fetchTickets();
</script>

</body>
</html>

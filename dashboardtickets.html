<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tickets PLAi</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      min-height: 100vh;
      color: #e0e0e0;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      width: 200%;
      height: 200%;
      top: -50%;
      left: -50%;
      background:
        radial-gradient(circle at 20% 50%, rgba(0, 150, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 50%);
      animation: rotate 20s linear infinite;
      z-index: 0;
    }

    @keyframes rotate { 100% { transform: rotate(360deg); } }

    header {
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    h1 {
      font-size: 2em;
      background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1::before { content: 'üìä'; font-size: 0.9em; }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .filters-title {
      font-size: 1.2em;
      color: #64ffda;
      font-weight: 600;
    }

    .toggle-filters {
      padding: 10px 16px;
      background: rgba(100, 255, 218, 0.1);
      border: 1px solid rgba(100, 255, 218, 0.3);
      border-radius: 8px;
      color: #64ffda;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-filters:hover {
      background: rgba(100, 255, 218, 0.2);
      transform: translateY(-2px);
    }

    .toggle-icon {
      transition: transform 0.3s ease;
      font-size: 1.2em;
    }

    .toggle-icon.open { transform: rotate(180deg); }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .controls.show {
      max-height: 1000px;
      opacity: 1;
      margin-top: 15px;
    }

    .controls > div { min-width: 0; }

    label {
      display: block;
      font-size: 0.85em;
      color: #64ffda;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(100, 255, 218, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      font-size: 0.95em;
      color: #e0e0e0;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #64ffda;
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 20px rgba(100, 255, 218, 0.2);
    }

    input::placeholder { color: #8892b0; }

    select { cursor: pointer; }
    select option { background: #1a1f3a; color: #e0e0e0; }

    button {
      padding: 12px 16px;
      border: 1px solid rgba(100, 255, 218, 0.3);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #e0e0e0;
      transition: all 0.3s ease;
      font-size: 0.95em;
    }

    button:hover {
      background: rgba(100, 255, 218, 0.1);
      border-color: #64ffda;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(100, 255, 218, 0.2);
    }

    button.primary {
      background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%);
      color: white;
      border: none;
    }

    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    main {
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      animation: slideUp 0.6s ease-out;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 212, 255, 0.2);
      border-color: rgba(100, 255, 218, 0.3);
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card .k {
      font-size: 0.85em;
      color: #8892b0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card .v {
      font-size: 2em;
      font-weight: 800;
      margin-top: 8px;
      background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tableWrap {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);

      overflow-x: auto;
      overflow-y: hidden;
      width: 100%;
    }

    table {
      width: 100%;
      min-width: 1200px;
      border-collapse: collapse;
    }

    th, td {
      padding: 16px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9em;
      vertical-align: middle;
      text-align: left;
      word-wrap: break-word;
    }

    th {
      font-size: 0.85em;
      color: #64ffda;
      background: rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 5;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      white-space: nowrap;
    }

    td { line-height: 1.6; }
    td strong { display: block; margin-bottom: 4px; }

    tr:hover td { background: rgba(100, 255, 218, 0.05); }

    .muted { color: #8892b0; font-size: 0.85em; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.8em;
      border: 1px solid;
    }

    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

    .p-alta { background: rgba(255, 71, 87, 0.15); border-color: rgba(255, 71, 87, 0.4); color: #ff4757; }
    .p-alta .dot { background: #ff4757; }

    .p-media { background: rgba(255, 165, 2, 0.15); border-color: rgba(255, 165, 2, 0.4); color: #ffa502; }
    .p-media .dot { background: #ffa502; }

    .p-baja { background: rgba(46, 213, 115, 0.15); border-color: rgba(46, 213, 115, 0.4); color: #2ed573; }
    .p-baja .dot { background: #2ed573; }

    .status { font-weight: 700; color: #64ffda; }

    .flag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.8em;
      border: 1px solid rgba(255, 203, 71, 0.5);
      background: rgba(255, 203, 71, 0.12);
      color: #ffcb47;
      margin-left: 8px;
      white-space: nowrap;
    }
    .flag .dot { background: #ffcb47; }

    .footer {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      align-items: center;
      flex-wrap: wrap;
    }

    .pager { display: flex; gap: 10px; align-items: center; }

    .error {
      margin-top: 12px;
      padding: 12px 16px;
      background: rgba(255, 71, 87, 0.1);
      border-left: 4px solid #ff4757;
      border-radius: 6px;
      color: #ff4757;
      font-weight: 700;
    }

    .ok {
      margin-top: 12px;
      padding: 12px 16px;
      background: rgba(46, 213, 115, 0.1);
      border-left: 4px solid #2ed573;
      border-radius: 6px;
      color: #2ed573;
      font-weight: 700;
    }

    .small { font-size: 0.8em; color: #8892b0; margin-top: 4px; }
    .btn-group { display: flex; gap: 8px; }

    /* ‚úÖ PREVIEW + MODAL */
    .imgCell { display: flex; gap: 10px; align-items: center; }
    .thumbBtn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(100, 255, 218, 0.25);
      background: rgba(255,255,255,0.05);
      color: #e0e0e0;
      cursor: pointer;
      transition: all .2s ease;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.85em;
      white-space: nowrap;
    }
    .thumbBtn:hover {
      border-color: rgba(100, 255, 218, 0.55);
      background: rgba(100, 255, 218, 0.08);
      transform: translateY(-1px);
    }
    .thumb {
      width: 44px; height: 44px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
    }
    .modal {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(6px);
    }
    .modal.show { display: flex; }
    .modalCard {
      width: min(1100px, 100%);
      background: rgba(15, 18, 40, 0.92);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      overflow: hidden;
    }
    .modalHeader {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .modalTitle { font-weight: 800; color: #64ffda; letter-spacing: 0.3px; }
    .modalActions { display: flex; gap: 10px; align-items: center; }
    .linkBtn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(100,255,218,0.25);
      background: rgba(255,255,255,0.05);
      color: #e0e0e0;
      text-decoration: none;
      font-weight: 800;
      font-size: 0.9em;
      transition: all .2s ease;
    }
    .linkBtn:hover {
      border-color: rgba(100,255,218,0.55);
      background: rgba(100,255,218,0.08);
      transform: translateY(-1px);
    }
    .closeBtn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,71,87,0.35);
      background: rgba(255,71,87,0.10);
      color: #ff4757;
      font-weight: 900;
      cursor: pointer;
      transition: all .2s ease;
    }
    .closeBtn:hover { background: rgba(255,71,87,0.18); transform: translateY(-1px); }
    .modalBody { padding: 16px; }
    .modalImg {
      width: 100%;
      max-height: 75vh;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.25);
    }

    @media (max-width: 1050px) {
      .controls { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 560px) {
      h1 { font-size: 1.5em; }
      .cards { grid-template-columns: 1fr; }
      .controls { grid-template-columns: 1fr; }
      .footer { flex-direction: column; align-items: stretch; }
      table { font-size: 0.85em; }
      th, td { padding: 12px 8px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Tickets PLAi</h1>

    <div class="filters-header">
      <div class="filters-title">üîç Filtros</div>
      <button class="toggle-filters" id="toggleFilters">
        <span>Mostrar filtros</span>
        <span class="toggle-icon">‚ñº</span>
      </button>
    </div>

    <div class="controls" id="filtersPanel">
      <div>
        <label>Buscar (ID / nombre / email / mensaje)</label>
        <input id="search" placeholder="Ej. correo, TICKET-2026..." />
      </div>

      <div>
        <label>Prioridad</label>
        <select id="prioridad">
          <option value="">Todas</option>
          <option value="alta">Alta</option>
          <option value="media">Media</option>
          <option value="baja">Baja</option>
        </select>
      </div>

      <div>
        <label>Estatus</label>
        <input id="estatus" placeholder="Ej. en revisi√≥n, abierto..." />
      </div>

      <div>
        <label>Categor√≠a</label>
        <input id="categoria" placeholder="Ej. T√©cnico, Facturaci√≥n..." />
      </div>

      <div>
        <label>√Årea de soporte</label>
        <select id="area">
          <option value="">Todas</option>
          <option value="plataformas">Plataformas</option>
          <option value="arquitectura">Arquitectura</option>
          <option value="infraestructura">Infraestructura</option>
          <option value="sin_clasificar">Sin clasificar</option>
        </select>
      </div>

      <div>
        <label>Orden</label>
        <select id="order">
          <option value="desc">M√°s recientes</option>
          <option value="asc">M√°s antiguos</option>
        </select>
      </div>

      <div>
        <label>L√≠mite por p√°gina</label>
        <select id="limit">
          <option value="20">20</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
          <option value="200">200</option>
        </select>
      </div>

      <div>
        <label>Auto-actualizar</label>
        <select id="auto">
          <option value="0">No</option>
          <option value="10">Cada 10s</option>
          <option value="20">Cada 20s</option>
          <option value="60">Cada 60s</option>
        </select>
      </div>

      <div>
        <label>Token (se env√≠a por query ?token=...)</label>
        <input id="token" placeholder="Si tu API requiere token, p√©galo aqu√≠" />
        <div class="small">Tip: se guarda en el navegador (localStorage).</div>
      </div>

      <div>
        <label>Acciones</label>
        <div class="btn-group">
          <button class="primary" id="refreshBtn">Actualizar</button>
          <button id="clearBtn">Limpiar</button>
        </div>
      </div>

      <div>
        <label>Endpoint</label>
        <div class="small" id="endpointText"></div>
      </div>
    </div>

    <div id="msg" class="muted"></div>
    <div id="err" class="error" style="display:none;"></div>
    <div id="ok" class="ok" style="display:none;"></div>
  </header>

  <main>
    <section class="cards">
      <div class="card">
        <div class="k">Tickets (p√°gina actual)</div>
        <div class="v" id="kCount">‚Äî</div>
      </div>
      <div class="card">
        <div class="k">Alta</div>
        <div class="v" id="kAlta">‚Äî</div>
      </div>
      <div class="card">
        <div class="k">Media</div>
        <div class="v" id="kMedia">‚Äî</div>
      </div>
      <div class="card">
        <div class="k">Baja</div>
        <div class="v" id="kBaja">‚Äî</div>
      </div>
    </section>

    <section class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="min-width: 140px;">Ticket</th>
            <th style="min-width: 140px;">Fecha</th>
            <th style="min-width: 100px;">Prioridad</th>
            <th style="min-width: 120px;">Categor√≠a</th>
            <th style="min-width: 160px;">√Årea</th>
            <th style="min-width: 120px;">Estatus</th>
            <th style="min-width: 180px;">Nombre / Email</th>
            <th style="min-width: 260px;">Mensaje del usuario</th>
            <th style="min-width: 170px;">Adjunto</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9" class="muted">Cargando‚Ä¶</td></tr>
        </tbody>
      </table>

      <div class="footer">
        <div class="muted" id="rangeText">‚Äî</div>

        <div class="pager">
          <button id="prevBtn">‚óÄ</button>
          <div class="muted">Offset: <span id="offsetText">0</span></div>
          <button id="nextBtn">‚ñ∂</button>
        </div>
      </div>
    </section>
  </main>

  <div class="modal" id="imgModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="Imagen adjunta">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">Adjunto</div>
        <div class="modalActions">
          <a class="linkBtn" id="openOriginal" href="#" target="_blank" rel="noopener noreferrer">Abrir en otra pesta√±a</a>
          <button class="closeBtn" id="closeModal">Cerrar ‚úï</button>
        </div>
      </div>
      <div class="modalBody">
        <img id="modalImg" class="modalImg" alt="Imagen adjunta del ticket" src="">
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // CONFIG
    // ===========================
    const API_BASE = "https://n8n.plai.mx/webhook";
    const API_PATH = "/dashboard/tickets";
    const ENDPOINT = API_BASE + API_PATH;

    // ===========================
    // STATE
    // ===========================
    let offset = 0;
    let autoTimer = null;

    // ‚úÖ guardamos lo que venga del API (aunque sean 400)
    let allTicketsCache = [];

    const els = {
      endpointText: document.getElementById("endpointText"),
      msg: document.getElementById("msg"),
      err: document.getElementById("err"),
      ok: document.getElementById("ok"),
      tbody: document.getElementById("tbody"),
      search: document.getElementById("search"),
      prioridad: document.getElementById("prioridad"),
      estatus: document.getElementById("estatus"),
      categoria: document.getElementById("categoria"),
      area: document.getElementById("area"),
      order: document.getElementById("order"),
      limit: document.getElementById("limit"),
      token: document.getElementById("token"),
      auto: document.getElementById("auto"),
      refreshBtn: document.getElementById("refreshBtn"),
      clearBtn: document.getElementById("clearBtn"),
      prevBtn: document.getElementById("prevBtn"),
      nextBtn: document.getElementById("nextBtn"),
      offsetText: document.getElementById("offsetText"),
      rangeText: document.getElementById("rangeText"),
      kCount: document.getElementById("kCount"),
      kAlta: document.getElementById("kAlta"),
      kMedia: document.getElementById("kMedia"),
      kBaja: document.getElementById("kBaja"),
      imgModal: document.getElementById("imgModal"),
      modalImg: document.getElementById("modalImg"),
      modalTitle: document.getElementById("modalTitle"),
      openOriginal: document.getElementById("openOriginal"),
      closeModal: document.getElementById("closeModal"),
    };

    els.endpointText.textContent = ENDPOINT;

    // ===========================
    // Helpers
    // ===========================
    function showError(text) {
      els.err.style.display = "block";
      els.err.textContent = text;
      els.ok.style.display = "none";
    }
    function showOk(text) {
      els.ok.style.display = "block";
      els.ok.textContent = text;
      els.err.style.display = "none";
    }
    function clearMessages() {
      els.err.style.display = "none";
      els.ok.style.display = "none";
      els.err.textContent = "";
      els.ok.textContent = "";
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => (
        { "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]
      ));
    }

    function fmtDate(iso) {
      if (!iso) return "";
      try {
        const d = new Date(iso);
        return d.toLocaleString("es-MX", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      } catch { return String(iso); }
    }

    function pillPrioridad(p) {
      const val = String(p || "").toLowerCase();
      const cls = val === "alta" ? "p-alta" : val === "baja" ? "p-baja" : "p-media";
      const label = val === "alta" ? "Alta" : val === "baja" ? "Baja" : "Media";
      return `<span class="pill ${cls}"><span class="dot"></span>${label}</span>`;
    }

    function pillArea(area, requiereRevision) {
      const a = String(area || "").toLowerCase();
      const label =
        a === "plataformas" ? "Plataformas" :
        a === "arquitectura" ? "Arquitectura" :
        a === "infraestructura" ? "Infraestructura" :
        a === "sin_clasificar" ? "Sin clasificar" :
        (area || "‚Äî");
      const rev = requiereRevision ? `<span class="flag"><span class="dot"></span>Revisi√≥n</span>` : "";
      return `<span>${escapeHtml(label)}</span>${rev}`;
    }

    function saveToken() {
      const t = els.token.value.trim();
      if (t) localStorage.setItem("dashboard_token", t);
      else localStorage.removeItem("dashboard_token");
    }

    function loadToken() {
      const t = localStorage.getItem("dashboard_token") || "";
      els.token.value = t;
    }

    function buildQuery() {
      const q = new URLSearchParams();
      // OJO: seguimos enviando filtros al API (si lo arreglas luego, funcionar√° server-side)
      const search = els.search.value.trim();
      const prioridad = els.prioridad.value.trim();
      const estatus = els.estatus.value.trim();
      const categoria = els.categoria.value.trim();
      const area = els.area.value.trim();
      const order = els.order.value.trim();
      const limit = els.limit.value.trim();
      const token = els.token.value.trim();

      if (search) q.set("search", search);
      if (prioridad) q.set("prioridad", prioridad);
      if (estatus) q.set("estatus", estatus);
      if (categoria) q.set("categoria", categoria);
      if (area) q.set("area", area);
      if (order) q.set("order", order);
      if (limit) q.set("limit", limit);
      q.set("offset", String(offset));
      if (token) q.set("token", token);

      return q.toString();
    }

    // ‚úÖ detecta la lista de tickets aunque venga en estructuras distintas
    function extractTickets(data) {
      if (!data) return [];
      if (Array.isArray(data.tickets)) return data.tickets;
      if (data.body && Array.isArray(data.body.tickets)) return data.body.tickets;
      if (data.data && Array.isArray(data.data.tickets)) return data.data.tickets;
      if (Array.isArray(data.rows)) return data.rows;
      return [];
    }

    // ‚úÖ URL de imagen (si existe)
    function getImageUrl(t) {
      const raw = (t && (t.imagen_url || t.image_url || t.adjunto_url || t.url_imagen)) || "";
      const url = String(raw || "").trim();
      if (!url) return "";
      if (!/^https?:\/\//i.test(url)) return "";
      return url;
    }

    // ‚úÖ FILTRADO CLIENT-SIDE (arregla ‚Äúno funcionan filtros‚Äù aunque el API mande todo)
    function applyClientFilters(list) {
      const search = els.search.value.trim().toLowerCase();
      const prioridad = els.prioridad.value.trim().toLowerCase();
      const estatus = els.estatus.value.trim().toLowerCase();
      const categoria = els.categoria.value.trim().toLowerCase();
      const area = els.area.value.trim().toLowerCase();

      return (list || []).filter(t => {
        const p = String(t.prioridad || "").toLowerCase();
        const e = String(t.estatus || "").toLowerCase();
        const c = String(t.categoria || "").toLowerCase();
        const a = String(t.area_soporte || "").toLowerCase();

        if (prioridad && p !== prioridad) return false;
        if (estatus && !e.includes(estatus)) return false;     // includes para ‚Äúen revisi√≥n‚Äù
        if (categoria && !c.includes(categoria)) return false; // includes para ‚ÄúGeneral‚Äù, ‚ÄúFacturaci√≥n‚Äù
        if (area && a !== area) return false;

        if (search) {
          const blob = [
            t.ticket_id, t.nombre, t.email, t.mensaje
          ].map(x => String(x || "").toLowerCase()).join(" ");
          if (!blob.includes(search)) return false;
        }

        return true;
      });
    }

    // ‚úÖ orden client-side (si el API ignora order)
    function sortClient(list) {
      const dir = (els.order.value || "desc").toLowerCase();
      const factor = dir === "asc" ? 1 : -1;
      return [...(list || [])].sort((a,b) => {
        const da = new Date(a.fecha_creacion || a.fecha_actualizacion || 0).getTime();
        const db = new Date(b.fecha_creacion || b.fecha_actualizacion || 0).getTime();
        return (da - db) * factor;
      });
    }

    // ===========================
    // Modal
    // ===========================
    function openModal(url, title) {
      els.modalTitle.textContent = title || "Adjunto";
      els.modalImg.src = url;
      els.openOriginal.href = url;
      els.imgModal.classList.add("show");
      els.imgModal.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
      els.imgModal.classList.remove("show");
      els.imgModal.setAttribute("aria-hidden", "true");
      els.modalImg.src = "";
      els.openOriginal.href = "#";
    }

    els.closeModal.addEventListener("click", closeModal);
    els.imgModal.addEventListener("click", (e) => { if (e.target === els.imgModal) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    // ===========================
    // Render (usa CACHE + filtros/paginaci√≥n client-side)
    // ===========================
    function renderFromCache() {
      const lim = parseInt(els.limit.value, 10) || 50;

      let filtered = applyClientFilters(allTicketsCache);
      filtered = sortClient(filtered);

      // si offset qued√≥ fuera (por ejemplo al cambiar filtros), lo corregimos
      if (offset >= filtered.length) offset = 0;
      els.offsetText.textContent = String(offset);

      const page = filtered.slice(offset, offset + lim);

      // KPIs (de la p√°gina actual)
      const alta = page.filter(t => (t.prioridad || "").toLowerCase() === "alta").length;
      const media = page.filter(t => (t.prioridad || "").toLowerCase() === "media").length;
      const baja = page.filter(t => (t.prioridad || "").toLowerCase() === "baja").length;

      els.kCount.textContent = String(page.length);
      els.kAlta.textContent = String(alta);
      els.kMedia.textContent = String(media);
      els.kBaja.textContent = String(baja);

      // Tabla
      if (page.length === 0) {
        els.tbody.innerHTML = `<tr><td colspan="9" class="muted">No hay resultados con esos filtros.</td></tr>`;
      } else {
        els.tbody.innerHTML = page.map(t => {
          const idRaw = (t.ticket_id || "");
          const id = escapeHtml(idRaw);
          const fecha = escapeHtml(fmtDate(t.fecha_creacion || t.fecha_actualizacion));
          const prioridadHtml = pillPrioridad(t.prioridad);
          const categoriaHtml = escapeHtml(t.categoria || "");
          const areaHtml = pillArea(t.area_soporte, !!t.requiere_revision);
          const estatusHtml = escapeHtml(t.estatus || "");
          const nombre = escapeHtml(t.nombre || "");
          const email = escapeHtml(t.email || "");
          const msgUsuario = escapeHtml(t.mensaje || "");

          const imgUrl = getImageUrl(t);
          const adjuntoCell = imgUrl
            ? `
              <div class="imgCell">
                <img class="thumb" src="${imgUrl}" alt="Adjunto ${id}" loading="lazy" referrerpolicy="no-referrer" />
                <button class="thumbBtn" type="button" data-img="${imgUrl}" data-title="Adjunto ‚Ä¢ ${escapeHtml(idRaw)}">Ver</button>
              </div>
            `
            : `<span class="muted">‚Äî</span>`;

          return `
            <tr>
              <td><strong style="color:#00d4ff;">${id}</strong></td>
              <td>${fecha}</td>
              <td>${prioridadHtml}</td>
              <td>${categoriaHtml}</td>
              <td>${areaHtml}</td>
              <td class="status">${estatusHtml}</td>
              <td>
                <div><strong>${nombre}</strong></div>
                <div class="muted">${email}</div>
              </td>
              <td>${msgUsuario || '<span class="muted">‚Äî</span>'}</td>
              <td>${adjuntoCell}</td>
            </tr>
          `;
        }).join("");

        // modal buttons
        els.tbody.querySelectorAll("button[data-img]").forEach(btn => {
          btn.addEventListener("click", () => {
            const img = btn.getAttribute("data-img");
            const title = btn.getAttribute("data-title") || "Adjunto";
            if (img) openModal(img, title);
          });
        });
      }

      const total = filtered.length;
      const from = total ? (offset + 1) : 0;
      const to = total ? Math.min(offset + page.length, total) : 0;
      els.rangeText.textContent = total
        ? `Mostrando ${from}‚Äì${to} de ${total} (l√≠mite ${lim})`
        : `Mostrando 0 resultados`;

      els.prevBtn.disabled = offset === 0;
      els.nextBtn.disabled = (offset + lim) >= total;
    }

    // ===========================
    // Fetch (solo actualiza cache)
    // ===========================
    async function loadTickets() {
      clearMessages();
      els.refreshBtn.disabled = true;
      els.msg.textContent = "Cargando tickets‚Ä¶";

      saveToken();

      const url = ENDPOINT + "?" + buildQuery();

      try {
        const res = await fetch(url, { method: "GET" });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          const msg = data?.error || data?.message || ("HTTP " + res.status);
          throw new Error(msg);
        }
        if (!data || data.ok !== true) {
          // tolerante: si tu Unwrap/Build cambia, aun as√≠ intentamos sacar tickets
          // pero dejamos aviso
          const maybe = extractTickets(data);
          if (!maybe.length) throw new Error("Respuesta inesperada del API.");
        }

        // ‚úÖ actualiza cache
        allTicketsCache = extractTickets(data);
        if (!Array.isArray(allTicketsCache)) allTicketsCache = [];

        // ‚úÖ render desde cache (filtros/paginaci√≥n client)
        renderFromCache();

        showOk("‚úÖ Actualizado correctamente");
      } catch (err) {
        showError("‚ùå Error: " + (err?.message || String(err)));
        allTicketsCache = [];
        els.tbody.innerHTML = `<tr><td colspan="9" class="muted">No se pudieron cargar tickets.</td></tr>`;
        els.rangeText.textContent = "‚Äî";
      } finally {
        els.refreshBtn.disabled = false;
        els.msg.textContent = "";
      }
    }

    // ===========================
    // Events
    // ===========================
    els.refreshBtn.addEventListener("click", () => loadTickets());

    els.clearBtn.addEventListener("click", () => {
      els.search.value = "";
      els.prioridad.value = "";
      els.estatus.value = "";
      els.categoria.value = "";
      els.area.value = "";
      els.order.value = "desc";
      offset = 0;
      renderFromCache(); // refleja limpieza instant√°nea
      loadTickets();     // y refresca desde API
    });

    // Enter en inputs
    ["search","estatus","categoria"].forEach(id => {
      document.getElementById(id).addEventListener("keydown", (e) => {
        if (e.key === "Enter") { offset = 0; loadTickets(); }
      });
    });

    // Cambios en filtros -> reset offset y render inmediato (y luego fetch)
    ["prioridad","order","limit","area"].forEach(id => {
      document.getElementById(id).addEventListener("change", () => {
        offset = 0;
        renderFromCache();
        loadTickets();
      });
    });

    // input typing: si quieres que filtre ‚Äúen vivo‚Äù (sin pegarle al API):
    // aqu√≠ filtramos local y SOLO al presionar Enter hacemos fetch.
    // (evita spam al API)
    ["search","estatus","categoria"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        offset = 0;
        renderFromCache();
      });
    });

    els.token.addEventListener("change", () => saveToken());

    els.prevBtn.addEventListener("click", () => {
      const lim = parseInt(els.limit.value, 10) || 50;
      offset = Math.max(offset - lim, 0);
      renderFromCache();
    });
    els.nextBtn.addEventListener("click", () => {
      const lim = parseInt(els.limit.value, 10) || 50;
      offset = offset + lim;
      renderFromCache();
    });

    els.auto.addEventListener("change", () => {
      if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
      const secs = parseInt(els.auto.value, 10) || 0;
      if (secs > 0) autoTimer = setInterval(() => loadTickets(), secs * 1000);
    });

    // Toggle filtros
    const toggleBtn = document.getElementById("toggleFilters");
    const filtersPanel = document.getElementById("filtersPanel");
    const toggleIcon = toggleBtn.querySelector(".toggle-icon");
    const toggleText = toggleBtn.querySelector("span:first-child");

    toggleBtn.addEventListener("click", () => {
      filtersPanel.classList.toggle("show");
      toggleIcon.classList.toggle("open");
      toggleText.textContent = filtersPanel.classList.contains("show") ? "Ocultar filtros" : "Mostrar filtros";
    });

    // ===========================
    // Init
    // ===========================
    loadToken();
    loadTickets();
  </script>
</body>
</html>
